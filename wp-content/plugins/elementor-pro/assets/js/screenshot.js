/*! elementor-pro - v3.9.0 - 06-12-2022 */
(()=>{"use strict";var __webpack_exports__={};
/*!**************************************************************!*\
  !*** ../modules/screenshots/assets/js/preview/screenshot.js ***!
  \**************************************************************/
class Screenshot extends elementorModules.ViewModule{getDefaultSettings(){return{empty_content_headline:'Empty Content.',crop:{width:1200,height:1500},excluded_external_css_urls:['https://kit-pro.fontawesome.com'],external_images_urls:['https://i.ytimg.com'],timeout:15000,render_timeout:5000,timerLabel:null,timer_label:`${ElementorScreenshotConfig.post_id} - timer`,image_placeholder:'data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACwAAAAAAQABAAACAkQBADs=',isDebug:elementorCommonConfig.isElementorDebug,isDebugSvg:false,...ElementorScreenshotConfig};}
getDefaultElements(){const $elementor=jQuery(ElementorScreenshotConfig.selector);const $sections=$elementor.find('.elementor-section-wrap > .elementor-section, .elementor > .elementor-section');return{$elementor,$sections,$firstSection:$sections.first(),$notElementorElements:elementorCommon.elements.$body.find('> *:not(style, link)').not($elementor),$head:jQuery('head')};}
onInit(){super.onInit();this.log('Screenshot init','time');this.timeoutTimer=setTimeout(this.screenshotFailed.bind(this),this.getSettings('timeout'));return this.captureScreenshot();}
captureScreenshot(){if(!this.elements.$elementor.length){elementorCommon.helpers.consoleWarn('Screenshots: The content of this page is empty, the module will create a fake conent just for this screenshot.');this.createFakeContent();}
this.removeUnnecessaryElements();this.handleIFrames();this.removeFirstSectionMargin();this.handleLinks();this.loadExternalCss();this.loadExternalImages();return Promise.resolve().then(this.createImage.bind(this)).then(this.createImageElement.bind(this)).then(this.cropCanvas.bind(this)).then(this.save.bind(this)).then(this.screenshotSucceed.bind(this)).catch(this.screenshotFailed.bind(this));}
createFakeContent(){this.elements.$elementor=jQuery('<div>').css({height:this.getSettings('crop.height'),width:this.getSettings('crop.width'),display:'flex',alignItems:'center',justifyContent:'center'});this.elements.$elementor.append(jQuery('<h1>').css({fontSize:'85px'}).html(this.getSettings('empty_content_headline')));document.body.prepend(this.elements.$elementor);}
loadExternalCss(){const excludedUrls=[this.getSettings('home_url'),...this.getSettings('excluded_external_css_urls')];const notSelector=excludedUrls.map(url=>`[href^="${url}"]`).join(', ');jQuery('link').not(notSelector).each((index,el)=>{const $link=jQuery(el),$newLink=$link.clone();$newLink.attr('href',this.getScreenshotProxyUrl($link.attr('href')));this.elements.$head.append($newLink);$link.remove();});}
loadExternalImages(){const selector=this.getSettings('external_images_urls').map(url=>`img[src^="${url}"]`).join(', ');jQuery(selector).each((index,el)=>{const $img=jQuery(el);$img.attr('src',this.getScreenshotProxyUrl($img.attr('src')));});}
handleIFrames(){this.elements.$elementor.find('iframe').each((index,el)=>{const $iframe=jQuery(el),$iframeMask=jQuery('<div />',{css:{background:'gray',width:$iframe.width(),height:$iframe.height()}});$iframe.before($iframeMask);$iframe.remove();});}
removeUnnecessaryElements(){let currentHeight=0;this.elements.$sections.filter((index,el)=>{let shouldBeRemoved=false;if(currentHeight>=this.getSettings('crop.height')){shouldBeRemoved=true;}
currentHeight+=jQuery(el).outerHeight();return shouldBeRemoved;}).each((index,el)=>{el.remove();});this.elements.$notElementorElements.remove();}
handleLinks(){elementorCommon.elements.$body.find('a').attr('href','/');}
removeFirstSectionMargin(){this.elements.$firstSection.css({marginTop:0});}
createImage(){const pageLoadedPromise=new Promise(resolve=>{window.addEventListener('load',()=>{resolve();});});const timeOutPromise=new Promise(resolve=>{setTimeout(()=>{resolve();},this.getSettings('render_timeout'));});return Promise.race([pageLoadedPromise,timeOutPromise]).then(()=>{this.log('Start creating screenshot.');if(this.getSettings('isDebugSvg')){domtoimage.toSvg(document.body,{imagePlaceholder:this.getSettings('image_placeholder')}).then(svg=>this.download(svg));return Promise.reject('Debug SVG.');}
const isSafari=/^((?!chrome|android).)*safari/i.test(window.userAgent);if(isSafari){this.log('Creating screenshot with "html2canvas"');return html2canvas(document.body).then(canvas=>{return canvas.toDataURL('image/png');});}
this.log('Creating screenshot with "dom-to-image"');return domtoimage.toPng(document.body,{imagePlaceholder:this.getSettings('image_placeholder')});});}
download(uri){const $link=jQuery('<a/>',{href:uri,download:'debugSvg.svg',html:'Download SVG'});elementorCommon.elements.$body.append($link);$link.trigger('click');}
createImageElement(dataUrl){const image=new Image();image.src=dataUrl;return new Promise(resolve=>{image.onload=()=>resolve(image);});}
cropCanvas(image){const width=this.getSettings('crop.width');const height=this.getSettings('crop.height');const cropCanvas=document.createElement('canvas'),cropContext=cropCanvas.getContext('2d'),ratio=width / image.width;cropCanvas.width=width;cropCanvas.height=height>image.height?image.height:height;cropContext.drawImage(image,0,0,image.width,image.height,0,0,image.width*ratio,image.height*ratio);return Promise.resolve(cropCanvas);}
save(canvas){return new Promise((resolve,reject)=>{elementorCommon.ajax.addRequest('screenshot_save',{data:{post_id:this.getSettings('post_id'),screenshot:canvas.toDataURL('image/png')},success:url=>{this.log(`Screenshot created: ${encodeURI(url)}`);resolve(url);},error:()=>{this.log('Failed to create screenshot.');reject();}});});}
markAsFailed(){return new Promise((resolve,reject)=>{elementorCommon.ajax.addRequest('screenshot_failed',{data:{post_id:this.getSettings('post_id')},success:()=>{this.log(`Marked as failed.`);resolve();},error:()=>{this.log('Failed to mark this screenshot as failed.');reject();}});});}
getScreenshotProxyUrl(url){return`${this.getSettings('home_url')}?screenshot_proxy&nonce=${this.getSettings('nonce')}&href=${url}`;}
screenshotSucceed(imageUrl){this.screenshotDone(true,imageUrl);}
screenshotFailed(e){this.log(e,null);this.markAsFailed().then(()=>this.screenshotDone(false));}
screenshotDone(success){let imageUrl=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;clearTimeout(this.timeoutTimer);this.timeoutTimer=null;window.parent.postMessage({name:'capture-screenshot-done',success,id:this.getSettings('post_id'),imageUrl},'*');this.log(`Screenshot ${success ? 'Succeed' : 'Failed'}.`,'timeEnd');}
log(message){let timerMethod=arguments.length>1&&arguments[1]!==undefined?arguments[1]:'timeLog';if(!this.getSettings('isDebug')){return;}
console.log('string'===typeof message?`${this.getSettings('post_id')} - ${message}`:message);if(timerMethod){console[timerMethod](this.getSettings('timer_label'));}}}
jQuery(()=>{new Screenshot();});})();